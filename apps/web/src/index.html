<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crypto Tracker MVP</title>
  <style>
    :root { --bg:#0b1020; --panel:#121a30; --muted:#8ea0c0; --text:#e9efff; --accent:#5aa9ff; --ok:#3ddc97; --danger:#ff6b6b; }
    * { box-sizing: border-box; font-family: Inter, system-ui, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .app { display:grid; grid-template-columns: 240px 1fr; min-height:100vh; }
    .sidebar { padding:18px; border-right:1px solid #233052; background:#0e1528; }
    .brand { font-weight:700; margin-bottom:18px; }
    .nav button { width:100%; text-align:left; background:transparent; color:var(--text); border:0; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .nav button.active, .nav button:hover { background:#1a2646; }
    .main { padding:20px; }
    .card { background:var(--panel); border:1px solid #233052; border-radius:14px; padding:14px; margin-bottom:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, button { border-radius:10px; border:1px solid #2a3a64; background:#0f1730; color:var(--text); padding:8px 10px; }
    button { cursor:pointer; }
    button.primary { background:var(--accent); color:#04122b; border-color:transparent; font-weight:700; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #233052; padding:10px 8px; text-align:left; }
    th { color:var(--muted); font-weight:600; }
    .muted { color:var(--muted); }
    .pill { padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #355084; }
    .in { color:var(--ok); }
    .out { color:var(--danger); }
    .grid2 { display:grid; grid-template-columns:repeat(2,minmax(220px,1fr)); gap:10px; }
    .hidden { display:none; }
    .kpi { font-size:22px; font-weight:700; }
    .note { font-size:12px; color:var(--muted); }
    .progress-wrap { width: 320px; max-width: 100%; }
    .progress-bar { width: 100%; height: 10px; border-radius: 999px; background: #1b2847; overflow: hidden; border:1px solid #2a3a64; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #5aa9ff, #3ddc97); transition: width .25s ease; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">⚔️ Crypto Tracker MVP</div>
      <div class="muted" style="margin-bottom:12px">Ethereum • ERC-20 • Confirmed only</div>
      <nav class="nav" id="nav"></nav>
    </aside>
    <main class="main">
      <section id="view-overview" class="view"></section>
      <section id="view-wallets" class="view hidden"></section>
      <section id="view-whitelist" class="view hidden"></section>
      <section id="view-transfers" class="view hidden"></section>
      <section id="view-summary" class="view hidden"></section>
      <section id="view-settings" class="view hidden"></section>
    </main>
  </div>

<script>
const tabs = [
  ['overview','Обзор'], ['wallets','Кошельки'], ['whitelist','Whitelist'],
  ['transfers','Транзакции'], ['summary','Сводка'], ['settings','Настройки']
];

const state = {
  wallets: [],
  whitelist: [],
  transfers: [],
  summaryMode: 'token',
  transferFilters: { start: '', end: '', direction: '', tokenContract: '', walletAddress: '' },
  summaryFilters: { start: '', end: '', direction: '', tokenContract: '', walletAddress: '' },
};

const fmt = (n) => Number(n || 0).toLocaleString('ru-RU', { maximumFractionDigits: 6 });

async function api(path, opts = {}) {
  const res = await fetch(path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts,
  });
  const text = await res.text();
  const data = text ? JSON.parse(text) : null;
  if (!res.ok) throw new Error(data?.error || ('HTTP ' + res.status));
  return data;
}

async function pollSyncStatus(onTick) {
  while (true) {
    const status = await api('/api/sync/status');
    onTick(status);
    if (!status.running) return status;
    await new Promise(r => setTimeout(r, 1200));
  }
}

async function startSyncWithProgress(noteEl, fillEl) {
  await api('/api/sync/trigger', { method: 'POST' });
  const finalStatus = await pollSyncStatus((status) => {
    fillEl.style.width = `${status.progress || 0}%`;
    noteEl.textContent = status.running
      ? `Синк: ${status.processedWallets}/${status.totalWallets} кошельков, +${status.inserted} записей`
      : (status.error
        ? `Ошибка: ${status.error}`
        : `Готово: ${status.processedWallets}/${status.totalWallets}, +${status.inserted}`);
  });
  return finalStatus;
}

function setTab(tab){
  document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
  document.getElementById('view-'+tab).classList.remove('hidden');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
}

function renderNav(){
  const nav = document.getElementById('nav');
  nav.innerHTML = tabs.map(([id,label])=>'<button data-tab="'+id+'">'+label+'</button>').join('');
  nav.querySelectorAll('button').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
}

function walletOptionsDatalist(id) {
  return `<datalist id="${id}">${state.wallets.map(w => `<option value="${w.address}">${w.label || ''}</option>`).join('')}</datalist>`;
}

function tokenOptions(optionsId) {
  return `<select id="${optionsId}"><option value="">Все токены</option>${state.whitelist.map(t => `<option value="${t.contractAddress}">${t.tokenName}</option>`).join('')}</select>`;
}

function renderOverview(){
  const incoming = state.transfers.filter(t=>t.direction==='incoming').reduce((s,t)=>s+Number(t.amountNormalized || 0),0);
  const outgoing = state.transfers.filter(t=>t.direction==='outgoing').reduce((s,t)=>s+Number(t.amountNormalized || 0),0);
  document.getElementById('view-overview').innerHTML = `
    <div class="card"><h2>Обзор</h2><div class="muted">Рабочий MVP на реальных API</div></div>
    <div class="grid2">
      <div class="card"><div class="muted">Кошельков</div><div class="kpi">${state.wallets.length}</div></div>
      <div class="card"><div class="muted">Whitelist токенов</div><div class="kpi">${state.whitelist.length}</div></div>
      <div class="card"><div class="muted">Входящие (текущая выборка)</div><div class="kpi in">${fmt(incoming)}</div></div>
      <div class="card"><div class="muted">Исходящие (текущая выборка)</div><div class="kpi out">${fmt(outgoing)}</div></div>
    </div>
    <div class="card"><div class="row">
      <button id="manual-sync" class="primary">Запустить поиск транзакций (Etherscan)</button>
      <div class="progress-wrap">
        <div class="progress-bar"><div id="sync-progress-fill" class="progress-fill"></div></div>
      </div>
      <span class="note" id="sync-note"></span>
    </div></div>`;

  document.getElementById('manual-sync').onclick = async () => {
    const note = document.getElementById('sync-note');
    const fill = document.getElementById('sync-progress-fill');
    note.textContent = 'Запуск...';
    fill.style.width = '0%';
    try {
      await startSyncWithProgress(note, fill);
      await refreshAll();
      renderOverview();
      renderTransfers();
      await loadSummary();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };
}

function renderWallets(){
  document.getElementById('view-wallets').innerHTML = `
    <div class="card"><h2>Кошельки</h2><div class="muted">Добавление вручную (copy/paste) + теги</div></div>
    <div class="card"><div class="row">
      <input id="wallet-address" placeholder="0x... address" style="min-width:280px" />
      <input id="wallet-label" placeholder="Label" />
      <input id="wallet-tags" placeholder="tags через запятую" style="min-width:220px" />
      <button id="add-wallet" class="primary">Добавить</button>
      <span class="note" id="wallet-note"></span>
    </div></div>
    <div class="card">
      <table><thead><tr><th>Address</th><th>Label</th><th>Тег кошелька</th><th></th></tr></thead>
      <tbody>${state.wallets.map(w=>`<tr><td>${w.address}</td><td>${w.label || ''}</td><td>${(w.tags || []).map(t=>t.tag).join(', ')}</td><td><button data-delete-wallet="${w.id}">Удалить</button></td></tr>`).join('')}</tbody></table>
    </div>`;

  document.getElementById('add-wallet').onclick = async () => {
    const note = document.getElementById('wallet-note');
    const address = document.getElementById('wallet-address').value.trim();
    const label = document.getElementById('wallet-label').value.trim();
    const tags = document.getElementById('wallet-tags').value.split(',').map(s => s.trim()).filter(Boolean);
    try {
      await api('/api/wallets', { method: 'POST', body: JSON.stringify({ address, label, tags }) });
      note.textContent = 'Добавлено';
      await refreshAll();
      renderWallets();
      renderOverview();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };

  document.querySelectorAll('[data-delete-wallet]').forEach((btn) => {
    btn.onclick = async () => {
      const note = document.getElementById('wallet-note');
      try {
        await api(`/api/wallets?id=${btn.dataset.deleteWallet}`, { method: 'DELETE' });
        note.textContent = 'Кошелёк удалён';
        await refreshAll();
        renderWallets();
        renderOverview();
      } catch (e) {
        note.textContent = 'Ошибка: ' + e.message;
      }
    };
  });
}

function renderWhitelist(){
  document.getElementById('view-whitelist').innerHTML = `
    <div class="card"><h2>Whitelist контрактов</h2><div class="muted">Только эти ERC-20 учитываются</div></div>
    <div class="card"><div class="row">
      <input id="token-name" placeholder="Token name (USDT)" />
      <input id="contract-address" placeholder="Contract address 0x..." style="min-width:360px" />
      <button id="add-token" class="primary">Добавить</button>
      <span class="note" id="token-note"></span>
    </div></div>
    <div class="card"><table><thead><tr><th>Token</th><th>Contract</th></tr></thead>
      <tbody>${state.whitelist.map(t=>`<tr><td>${t.tokenName}</td><td>${t.contractAddress}</td></tr>`).join('')}</tbody></table></div>`;

  document.getElementById('add-token').onclick = async () => {
    const note = document.getElementById('token-note');
    const tokenName = document.getElementById('token-name').value.trim();
    const contractAddress = document.getElementById('contract-address').value.trim();
    try {
      await api('/api/whitelist', { method: 'POST', body: JSON.stringify({ tokenName, contractAddress }) });
      note.textContent = 'Добавлено';
      await refreshAll();
      renderWhitelist();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };
}

function buildQueryFromFilters(filters) {
  const q = new URLSearchParams();
  if (filters.start) q.set('start', filters.start);
  if (filters.end) q.set('end', filters.end);
  if (filters.direction) q.set('direction', filters.direction);
  if (filters.tokenContract) q.set('tokenContract', filters.tokenContract);
  if (filters.walletAddress) q.set('walletAddress', filters.walletAddress);
  return q.toString();
}

async function loadTransfers() {
  const q = buildQueryFromFilters(state.transferFilters);
  state.transfers = await api('/api/transfers' + (q ? '?' + q : ''));
  renderTransfers();
  renderOverview();
}

function renderTransfers(){
  document.getElementById('view-transfers').innerHTML = `
    <div class="card"><h2>Транзакции</h2><div class="muted">Реальные данные из БД</div></div>
    <div class="card"><div class="row">
      <input id="t-start" type="date" value="${state.transferFilters.start}" /><input id="t-end" type="date" value="${state.transferFilters.end}" />
      <select id="t-direction"><option value="" ${state.transferFilters.direction === '' ? 'selected' : ''}>Все направления</option><option value="incoming" ${state.transferFilters.direction === 'incoming' ? 'selected' : ''}>Incoming</option><option value="outgoing" ${state.transferFilters.direction === 'outgoing' ? 'selected' : ''}>Outgoing</option></select>
      <select id="t-token"><option value="">Все токены</option>${state.whitelist.map(t => `<option value="${t.contractAddress}" ${state.transferFilters.tokenContract === t.contractAddress ? 'selected' : ''}>${t.tokenName}</option>`).join('')}</select>
      <input id="t-wallet" list="wallet-options-transfers" placeholder="Поиск кошелька (вставь адрес)" style="min-width:280px" value="${state.transferFilters.walletAddress}" />
      ${walletOptionsDatalist('wallet-options-transfers')}
      <button id="t-apply">Применить</button>
      <button id="t-refresh">Обновить</button>
      <button id="t-sync" class="primary">Искать в Etherscan</button>
      <div class="progress-wrap"><div class="progress-bar"><div id="t-sync-fill" class="progress-fill"></div></div></div>
      <span id="t-sync-note" class="note"></span>
    </div></div>
    <div class="card"><table><thead><tr><th>Дата</th><th>Кошелёк</th><th>Токен</th><th>Напр.</th><th>Сумма</th><th>TX</th></tr></thead>
      <tbody>${state.transfers.map(t=>`<tr><td>${new Date(t.blockTimestamp).toLocaleString('ru-RU')}</td><td>${t.wallet?.address || ''}</td><td>${t.tokenName}</td><td><span class="pill ${t.direction==='incoming'?'in':'out'}">${t.direction}</span></td><td>${fmt(t.amountNormalized)}</td><td><a href="https://etherscan.io/tx/${t.txHash}" target="_blank" rel="noopener noreferrer">${t.txHash.slice(0,12)}...</a></td></tr>`).join('')}</tbody></table></div>`;

  const tStart = document.getElementById('t-start');
  const tEnd = document.getElementById('t-end');
  const tDirection = document.getElementById('t-direction');
  const tToken = document.getElementById('t-token');
  const tWallet = document.getElementById('t-wallet');

  const syncTransferFiltersFromUi = () => {
    state.transferFilters.start = tStart.value || '';
    state.transferFilters.end = tEnd.value || '';
    state.transferFilters.direction = tDirection.value || '';
    state.transferFilters.tokenContract = tToken.value || '';
    state.transferFilters.walletAddress = tWallet.value || '';
  };

  [tStart, tEnd, tDirection, tToken, tWallet].forEach((el) => {
    el.addEventListener('change', syncTransferFiltersFromUi);
    el.addEventListener('input', syncTransferFiltersFromUi);
  });

  document.getElementById('t-apply').onclick = async () => {
    syncTransferFiltersFromUi();
    await loadTransfers();
  };
  document.getElementById('t-refresh').onclick = async () => { await refreshAll(); await loadTransfers(); };
  document.getElementById('t-sync').onclick = async () => {
    const note = document.getElementById('t-sync-note');
    const fill = document.getElementById('t-sync-fill');
    note.textContent = 'Запуск...';
    fill.style.width = '0%';
    try {
      await startSyncWithProgress(note, fill);
      await refreshAll();
      await loadTransfers();
      renderOverview();
      await loadSummary();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };
}

async function loadSummary() {
  const q = buildQueryFromFilters(state.summaryFilters);
  const data = await api(`/api/summary?mode=${state.summaryMode}` + (q ? '&' + q : ''));
  renderSummary(data);
}

function renderSummary(summaryRows = []){
  document.getElementById('view-summary').innerHTML = `
    <div class="card"><h2>Сводка</h2><div class="muted">Итоги по токенам или кошелькам</div></div>
    <div class="card"><div class="row">
      <input id="s-start" type="date" value="${state.summaryFilters.start}" /><input id="s-end" type="date" value="${state.summaryFilters.end}" />
      <select id="s-direction"><option value="" ${state.summaryFilters.direction === '' ? 'selected' : ''}>Все направления</option><option value="incoming" ${state.summaryFilters.direction === 'incoming' ? 'selected' : ''}>Incoming</option><option value="outgoing" ${state.summaryFilters.direction === 'outgoing' ? 'selected' : ''}>Outgoing</option></select>
      <select id="s-token"><option value="">Все токены</option>${state.whitelist.map(t => `<option value="${t.contractAddress}" ${state.summaryFilters.tokenContract === t.contractAddress ? 'selected' : ''}>${t.tokenName}</option>`).join('')}</select>
      <input id="s-wallet" list="wallet-options-summary" placeholder="Поиск кошелька (вставь адрес)" style="min-width:280px" value="${state.summaryFilters.walletAddress}" />
      ${walletOptionsDatalist('wallet-options-summary')}
      <button id="s-apply">Применить</button>
      <button id="s-refresh">Обновить</button>
      <button id="s-mode-token" class="${state.summaryMode === 'token' ? 'primary' : ''}">По токенам</button>
      <button id="s-mode-wallet" class="${state.summaryMode === 'wallet' ? 'primary' : ''}">По кошелькам</button>
    </div></div>
    <div class="card"><table><thead><tr><th>${state.summaryMode === 'token' ? 'Токен' : 'Кошелёк'}</th>${state.summaryMode === 'wallet' ? '<th>Теги</th>' : ''}<th>Вход</th><th>Выход</th></tr></thead>
      <tbody>${summaryRows.map(r => `<tr><td>${r.key}</td>${state.summaryMode === 'wallet' ? `<td>${(r.walletTags || []).join(', ')}</td>` : ''}<td class="in">${fmt(r.incoming)}</td><td class="out">${fmt(r.outgoing)}</td></tr>`).join('')}</tbody></table></div>`;

  const sStart = document.getElementById('s-start');
  const sEnd = document.getElementById('s-end');
  const sDirection = document.getElementById('s-direction');
  const sToken = document.getElementById('s-token');
  const sWallet = document.getElementById('s-wallet');

  const syncSummaryFiltersFromUi = () => {
    state.summaryFilters.start = sStart.value || '';
    state.summaryFilters.end = sEnd.value || '';
    state.summaryFilters.direction = sDirection.value || '';
    state.summaryFilters.tokenContract = sToken.value || '';
    state.summaryFilters.walletAddress = sWallet.value || '';
  };

  [sStart, sEnd, sDirection, sToken, sWallet].forEach((el) => {
    el.addEventListener('change', syncSummaryFiltersFromUi);
    el.addEventListener('input', syncSummaryFiltersFromUi);
  });

  document.getElementById('s-apply').onclick = async () => {
    syncSummaryFiltersFromUi();
    await loadSummary();
  };
  document.getElementById('s-refresh').onclick = async () => { await refreshAll(); await loadSummary(); };
  document.getElementById('s-mode-token').onclick = async () => { state.summaryMode = 'token'; await loadSummary(); };
  document.getElementById('s-mode-wallet').onclick = async () => { state.summaryMode = 'wallet'; await loadSummary(); };
}

function renderSettings(){
  document.getElementById('view-settings').innerHTML = `
    <div class="card"><h2>Настройки</h2><div class="muted">Автообновление + роли</div></div>
    <div class="card"><div class="row"><label>Auto-refresh interval:</label><select><option>1 minute</option><option>1 hour</option><option>1 day</option></select><button class="primary">Сохранить</button></div></div>
    <div class="card"><h3>Роли доступа</h3><ul><li><b>admin</b> — полный доступ</li><li><b>read_only</b> — только просмотр</li></ul></div>`;
}

async function refreshAll() {
  state.wallets = await api('/api/wallets');
  state.whitelist = await api('/api/whitelist');
  state.transfers = await api('/api/transfers');
}

(async function init() {
  renderNav();
  await refreshAll();
  renderOverview();
  renderWallets();
  renderWhitelist();
  renderTransfers();
  await loadSummary();
  renderSettings();
  setTab('overview');
})();
</script>
</body>
</html>
