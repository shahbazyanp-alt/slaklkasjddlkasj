<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crypto Tracker MVP</title>
  <style>
    :root { --bg:#0b1020; --panel:#121a30; --muted:#8ea0c0; --text:#e9efff; --accent:#5aa9ff; --ok:#3ddc97; --danger:#ff6b6b; }
    * { box-sizing: border-box; font-family: Inter, system-ui, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .app { display:grid; grid-template-columns: 240px 1fr; min-height:100vh; }
    .sidebar { padding:18px; border-right:1px solid #233052; background:#0e1528; }
    .brand { font-weight:700; margin-bottom:18px; }
    .nav button { width:100%; text-align:left; background:transparent; color:var(--text); border:0; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .nav button.active, .nav button:hover { background:#1a2646; }
    .main { padding:20px; }
    .card { background:var(--panel); border:1px solid #233052; border-radius:14px; padding:14px; margin-bottom:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, button { border-radius:10px; border:1px solid #2a3a64; background:#0f1730; color:var(--text); padding:8px 10px; }
    button { cursor:pointer; }
    button.primary { background:var(--accent); color:#04122b; border-color:transparent; font-weight:700; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #233052; padding:10px 8px; text-align:left; }
    th { color:var(--muted); font-weight:600; }
    .muted { color:var(--muted); }
    .pill { padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #355084; }
    .in { color:var(--ok); }
    .out { color:var(--danger); }
    .grid2 { display:grid; grid-template-columns:repeat(2,minmax(220px,1fr)); gap:10px; }
    .hidden { display:none; }
    .kpi { font-size:22px; font-weight:700; }
    .note { font-size:12px; color:var(--muted); }
    .progress-wrap { width: 320px; max-width: 100%; }
    .progress-bar { width: 100%; height: 10px; border-radius: 999px; background: #1b2847; overflow: hidden; border:1px solid #2a3a64; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #5aa9ff, #3ddc97); transition: width .25s ease; }
    .sync-log { max-height: 180px; overflow:auto; padding:10px; background:#0b1226; border:1px solid #2a3a64; border-radius:10px; font-size:12px; }
    .sync-log .warn { color:#ffd166; }
    .sync-log .error { color:#ff6b6b; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">⚔️ Crypto Tracker MVP</div>
      <div class="muted" style="margin-bottom:12px">Ethereum • ERC-20 • Confirmed only</div>
      <nav class="nav" id="nav"></nav>
    </aside>
    <main class="main">
      <section id="view-overview" class="view"></section>
      <section id="view-wallets" class="view hidden"></section>
      <section id="view-whitelist" class="view hidden"></section>
      <section id="view-transfers" class="view hidden"></section>
      <section id="view-summary" class="view hidden"></section>
      <section id="view-balances" class="view hidden"></section>
      <section id="view-tags" class="view hidden"></section>
      <section id="view-settings" class="view hidden"></section>
    </main>
  </div>

<script>
const tabs = [
  ['overview','Обзор'], ['wallets','Кошельки'], ['whitelist','Whitelist'],
  ['transfers','Транзакции'], ['summary','Сводка'], ['balances','Балансы'], ['tags','Теги'], ['settings','Настройки']
];

const state = {
  wallets: [],
  whitelist: [],
  transfers: [],
  tags: [],
  balances: [],
  summaryMode: 'token',
  filters: { start: '', end: '', direction: '', tokenContract: '', walletAddress: '', walletTag: '', includeSpam: false },
  balanceFilters: { tokenContract: '', walletTag: '' },
  balanceSort: 'asc',
};

const fmt = (n) => Number(n || 0).toLocaleString('ru-RU', { maximumFractionDigits: 6 });

async function api(path, opts = {}) {
  const res = await fetch(path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts,
  });
  const text = await res.text();
  const data = text ? JSON.parse(text) : null;
  if (!res.ok) throw new Error(data?.error || ('HTTP ' + res.status));
  return data;
}

async function pollSyncStatus(onTick) {
  while (true) {
    const status = await api('/api/sync/status');
    onTick(status);
    if (!status.running) return status;
    await new Promise(r => setTimeout(r, 1200));
  }
}

function renderSyncLogs(logEl, logs = []) {
  if (!logEl) return;
  const rows = logs.slice(-80).map((l) => {
    const cls = l.level === 'warn' ? 'warn' : l.level === 'error' ? 'error' : '';
    const time = new Date(l.ts).toLocaleTimeString('ru-RU');
    return `<div class="${cls}">[${time}] ${l.message}</div>`;
  });
  logEl.innerHTML = rows.join('') || '<div class="muted">Лог пуст</div>';
  logEl.scrollTop = logEl.scrollHeight;
}

async function startSyncWithProgress(noteEl, fillEl, logEl) {
  await api('/api/sync/trigger', { method: 'POST' });
  const finalStatus = await pollSyncStatus((status) => {
    fillEl.style.width = `${status.progress || 0}%`;
    noteEl.textContent = status.running
      ? `Синк: ${status.processedWallets}/${status.totalWallets} кошельков, +${status.inserted} записей`
      : (status.error
        ? `Ошибка: ${status.error}`
        : `Готово: ${status.processedWallets}/${status.totalWallets}, +${status.inserted}`);
    renderSyncLogs(logEl, status.logs || []);
  });
  return finalStatus;
}

async function setTab(tab){
  document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
  document.getElementById('view-'+tab).classList.remove('hidden');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));

  if (tab === 'transfers') {
    await loadTransfers();
  }
  if (tab === 'summary') {
    await loadSummary();
  }
  if (tab === 'balances') {
    await loadBalances();
  }
  if (tab === 'tags') {
    renderTagsAdmin();
  }
}

function renderNav(){
  const nav = document.getElementById('nav');
  nav.innerHTML = tabs.map(([id,label])=>'<button data-tab="'+id+'">'+label+'</button>').join('');
  nav.querySelectorAll('button').forEach(b=>b.onclick=()=>{ setTab(b.dataset.tab); });
}

function walletOptionsDatalist(id) {
  return `<datalist id="${id}">${state.wallets.map(w => `<option value="${w.address}">${w.label || ''}</option>`).join('')}</datalist>`;
}

function tokenOptions(optionsId) {
  return `<select id="${optionsId}"><option value="">Все токены</option>${state.whitelist.map(t => `<option value="${t.contractAddress}">${t.tokenName}</option>`).join('')}</select>`;
}

function renderOverview(){
  const incoming = state.transfers.filter(t=>t.direction==='incoming').reduce((s,t)=>s+Number(t.amountNormalized || 0),0);
  const outgoing = state.transfers.filter(t=>t.direction==='outgoing').reduce((s,t)=>s+Number(t.amountNormalized || 0),0);
  document.getElementById('view-overview').innerHTML = `
    <div class="card"><h2>Обзор</h2><div class="muted">Рабочий MVP на реальных API</div></div>
    <div class="grid2">
      <div class="card"><div class="muted">Кошельков</div><div class="kpi">${state.wallets.length}</div></div>
      <div class="card"><div class="muted">Whitelist токенов</div><div class="kpi">${state.whitelist.length}</div></div>
      <div class="card"><div class="muted">Входящие (текущая выборка)</div><div class="kpi in">${fmt(incoming)}</div></div>
      <div class="card"><div class="muted">Исходящие (текущая выборка)</div><div class="kpi out">${fmt(outgoing)}</div></div>
    </div>
    <div class="card"><div class="row">
      <button id="manual-sync" class="primary">Запустить поиск транзакций (Etherscan)</button>
      <div class="progress-wrap">
        <div class="progress-bar"><div id="sync-progress-fill" class="progress-fill"></div></div>
      </div>
      <span class="note" id="sync-note"></span>
    </div>
    <div style="margin-top:10px" class="sync-log" id="sync-log"></div>
    </div>`;

  document.getElementById('manual-sync').onclick = async () => {
    const note = document.getElementById('sync-note');
    const fill = document.getElementById('sync-progress-fill');
    const log = document.getElementById('sync-log');
    note.textContent = 'Запуск...';
    fill.style.width = '0%';
    renderSyncLogs(log, []);
    try {
      await startSyncWithProgress(note, fill, log);
      await refreshAll();
      renderOverview();
      renderTransfers();
      await loadSummary();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };
}

function renderWallets(){
  document.getElementById('view-wallets').innerHTML = `
    <div class="card"><h2>Кошельки</h2><div class="muted">Добавление вручную (copy/paste) + теги</div></div>
    <div class="card"><div class="row">
      <input id="wallet-address" placeholder="0x... address" style="min-width:280px" />
      <input id="wallet-label" placeholder="Label" />
      <input id="wallet-number" placeholder="Номер кошелька" style="min-width:150px" />
      <input id="wallet-tags" placeholder="tags через запятую" style="min-width:220px" />
      <button id="add-wallet" class="primary">Добавить</button>
      <span class="note" id="wallet-note"></span>
    </div></div>
    <div class="card">
      <h3>Массовое добавление кошельков</h3>
      <div class="muted">Вставь список адресов (по одному в строке, или через пробел/запятую)</div>
      <div class="row" style="margin-top:8px">
        <textarea id="wallet-bulk-input" placeholder="0x...\n0x...\n0x..." style="min-width:480px;min-height:120px;background:#0f1730;color:#e9efff;border:1px solid #2a3a64;border-radius:10px;padding:10px"></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="add-wallet-bulk" class="primary">Добавить списком</button>
        <span class="note" id="wallet-bulk-note"></span>
      </div>
    </div>
    <div class="card">
      <table><thead><tr><th>Address</th><th>Номер кошелька</th><th>Label</th><th>Тег кошелька</th><th></th></tr></thead>
      <tbody>${state.wallets.map(w=>`<tr><td>${w.address}</td><td><input data-wallet-number-input="${w.id}" value="${w.walletNumber || ''}" placeholder="номер" style="min-width:120px"/> <button data-save-wallet-number="${w.id}">Сохранить</button></td><td>${w.label || ''}</td><td>${(w.tags || []).map(t=>t.tag).join(', ')}</td><td><button data-delete-wallet="${w.id}">Удалить</button></td></tr>`).join('')}</tbody></table>
    </div>`;

  document.getElementById('add-wallet').onclick = async () => {
    const note = document.getElementById('wallet-note');
    const address = document.getElementById('wallet-address').value.trim();
    const label = document.getElementById('wallet-label').value.trim();
    const walletNumber = document.getElementById('wallet-number').value.trim();
    const tags = document.getElementById('wallet-tags').value.split(',').map(s => s.trim()).filter(Boolean);
    try {
      await api('/api/wallets', { method: 'POST', body: JSON.stringify({ address, label, walletNumber, tags }) });
      note.textContent = 'Добавлено';
      await refreshAll();
      renderWallets();
      renderOverview();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };

  document.querySelectorAll('[data-save-wallet-number]').forEach((btn) => {
    btn.onclick = async () => {
      const note = document.getElementById('wallet-note');
      const id = btn.dataset.saveWalletNumber;
      const input = document.querySelector(`[data-wallet-number-input="${id}"]`);
      const walletNumber = input?.value?.trim() || '';
      try {
        await api('/api/wallets/number', { method: 'PUT', body: JSON.stringify({ id, walletNumber }) });
        note.textContent = 'Номер кошелька сохранён';
        await refreshAll();
        renderWallets();
      } catch (e) {
        note.textContent = 'Ошибка: ' + e.message;
      }
    };
  });

  document.getElementById('add-wallet-bulk').onclick = async () => {
    const note = document.getElementById('wallet-bulk-note');
    const addresses = document.getElementById('wallet-bulk-input').value;
    try {
      const r = await api('/api/wallets/bulk', { method: 'POST', body: JSON.stringify({ addresses }) });
      note.textContent = `Готово: добавлено ${r.created}, пропущено ${r.skippedExisting}, невалидных ${r.invalid.length}`;
      await refreshAll();
      renderWallets();
      renderOverview();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };

  document.querySelectorAll('[data-delete-wallet]').forEach((btn) => {
    btn.onclick = async () => {
      const note = document.getElementById('wallet-note');
      try {
        await api(`/api/wallets?id=${btn.dataset.deleteWallet}`, { method: 'DELETE' });
        note.textContent = 'Кошелёк удалён';
        await refreshAll();
        renderWallets();
        renderOverview();
      } catch (e) {
        note.textContent = 'Ошибка: ' + e.message;
      }
    };
  });
}

function renderWhitelist(){
  document.getElementById('view-whitelist').innerHTML = `
    <div class="card"><h2>Whitelist контрактов</h2><div class="muted">Только эти ERC-20 учитываются</div></div>
    <div class="card"><div class="row">
      <input id="token-name" placeholder="Token name (USDT)" />
      <input id="contract-address" placeholder="Contract address 0x..." style="min-width:360px" />
      <button id="add-token" class="primary">Добавить</button>
      <span class="note" id="token-note"></span>
    </div></div>
    <div class="card"><table><thead><tr><th>Token</th><th>Contract</th></tr></thead>
      <tbody>${state.whitelist.map(t=>`<tr><td>${t.tokenName}</td><td>${t.contractAddress}</td></tr>`).join('')}</tbody></table></div>`;

  document.getElementById('add-token').onclick = async () => {
    const note = document.getElementById('token-note');
    const tokenName = document.getElementById('token-name').value.trim();
    const contractAddress = document.getElementById('contract-address').value.trim();
    try {
      await api('/api/whitelist', { method: 'POST', body: JSON.stringify({ tokenName, contractAddress }) });
      note.textContent = 'Добавлено';
      await refreshAll();
      renderWhitelist();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };
}

function buildQueryFromFilters(filters) {
  const q = new URLSearchParams();
  if (filters.start) q.set('start', filters.start);
  if (filters.end) q.set('end', filters.end);
  if (filters.direction) q.set('direction', filters.direction);
  if (filters.tokenContract) q.set('tokenContract', filters.tokenContract);
  if (filters.walletAddress) q.set('walletAddress', filters.walletAddress);
  if (filters.walletTag) q.set('walletTag', filters.walletTag);
  if (filters.includeSpam) q.set('includeSpam', '1');
  return q.toString();
}

async function loadTransfers() {
  const q = buildQueryFromFilters(state.filters);
  state.transfers = await api('/api/transfers' + (q ? '?' + q : ''));
  renderTransfers();
  renderOverview();
}

function renderTransfers(){
  const totalIncoming = state.transfers
    .filter((t) => t.direction === 'incoming')
    .reduce((s, t) => s + Number(t.amountNormalized || 0), 0);
  const totalOutgoing = state.transfers
    .filter((t) => t.direction === 'outgoing')
    .reduce((s, t) => s + Number(t.amountNormalized || 0), 0);

  document.getElementById('view-transfers').innerHTML = `
    <div class="card"><h2>Транзакции</h2><div class="muted">Реальные данные из БД. По умолчанию скрываем только нулевые спам-транзакции (amount=0), денежные транзакции не скрываются.</div></div>
    <div class="card"><div class="row">
      <input id="t-start" type="date" value="${state.filters.start}" /><input id="t-end" type="date" value="${state.filters.end}" />
      <select id="t-direction"><option value="" ${state.filters.direction === '' ? 'selected' : ''}>Все направления</option><option value="incoming" ${state.filters.direction === 'incoming' ? 'selected' : ''}>Incoming</option><option value="outgoing" ${state.filters.direction === 'outgoing' ? 'selected' : ''}>Outgoing</option></select>
      <select id="t-token"><option value="">Все токены</option>${state.whitelist.map(t => `<option value="${t.contractAddress}" ${state.filters.tokenContract === t.contractAddress ? 'selected' : ''}>${t.tokenName}</option>`).join('')}</select>
      <select id="t-tag"><option value="">Все теги</option>${state.tags.map(t => `<option value="${t.tag}" ${state.filters.walletTag === t.tag ? 'selected' : ''}>${t.tag}</option>`).join('')}</select>
      <label class="note" style="display:flex;align-items:center;gap:6px"><input id="t-include-spam" type="checkbox" ${state.filters.includeSpam ? 'checked' : ''} />Показывать нулевые/спам</label>
      <input id="t-wallet" list="wallet-options-transfers" placeholder="Поиск кошелька (вставь адрес)" style="min-width:280px" value="${state.filters.walletAddress}" />
      ${walletOptionsDatalist('wallet-options-transfers')}
      <button id="t-apply">Применить</button>
      <button id="t-refresh">Обновить</button>
      <button id="t-sync" class="primary">Искать в Etherscan</button>
      <div class="progress-wrap"><div class="progress-bar"><div id="t-sync-fill" class="progress-fill"></div></div></div>
      <span id="t-sync-note" class="note"></span>
    </div>
    <div style="margin-top:10px" class="sync-log" id="t-sync-log"></div>
    </div>
    <div class="card"><table>
      <thead><tr><th>Дата</th><th>Кошелёк</th><th>Токен</th><th>Напр.</th><th>Приход</th><th>Расход</th><th>TX</th></tr></thead>
      <tbody>${state.transfers.map(t=>`<tr><td>${new Date(t.blockTimestamp).toLocaleString('ru-RU')}</td><td>${t.wallet?.address || ''}</td><td>${t.tokenName}</td><td><span class="pill ${t.direction==='incoming'?'in':'out'}">${t.direction}</span></td><td class="in">${t.direction==='incoming' ? fmt(t.amountNormalized) : ''}</td><td class="out">${t.direction==='outgoing' ? fmt(t.amountNormalized) : ''}</td><td><a href="https://etherscan.io/tx/${t.txHash}" target="_blank" rel="noopener noreferrer">${t.txHash.slice(0,12)}...</a></td></tr>`).join('')}</tbody>
      <tfoot><tr><th colspan="4">Итого</th><th class="in">${fmt(totalIncoming)}</th><th class="out">${fmt(totalOutgoing)}</th><th></th></tr></tfoot>
    </table></div>`;

  const tStart = document.getElementById('t-start');
  const tEnd = document.getElementById('t-end');
  const tDirection = document.getElementById('t-direction');
  const tToken = document.getElementById('t-token');
  const tTag = document.getElementById('t-tag');
  const tIncludeSpam = document.getElementById('t-include-spam');
  const tWallet = document.getElementById('t-wallet');

  const syncTransferFiltersFromUi = () => {
    state.filters.start = tStart.value || '';
    state.filters.end = tEnd.value || '';
    state.filters.direction = tDirection.value || '';
    state.filters.tokenContract = tToken.value || '';
    state.filters.walletTag = tTag.value || '';
    state.filters.includeSpam = !!tIncludeSpam.checked;
    state.filters.walletAddress = tWallet.value || '';
  };

  [tStart, tEnd, tDirection, tToken, tTag, tIncludeSpam, tWallet].forEach((el) => {
    el.addEventListener('change', syncTransferFiltersFromUi);
    el.addEventListener('input', syncTransferFiltersFromUi);
  });

  document.getElementById('t-apply').onclick = async () => {
    syncTransferFiltersFromUi();
    await loadTransfers();
  };
  document.getElementById('t-refresh').onclick = async () => { await refreshAll(); await loadTransfers(); };
  document.getElementById('t-sync').onclick = async () => {
    const note = document.getElementById('t-sync-note');
    const fill = document.getElementById('t-sync-fill');
    const log = document.getElementById('t-sync-log');
    note.textContent = 'Запуск...';
    fill.style.width = '0%';
    renderSyncLogs(log, []);
    try {
      await startSyncWithProgress(note, fill, log);
      await refreshAll();
      await loadTransfers();
      renderOverview();
      await loadSummary();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };
}

async function loadSummary() {
  const q = buildQueryFromFilters(state.filters);
  const data = await api(`/api/summary?mode=${state.summaryMode}` + (q ? '&' + q : ''));
  renderSummary(data);
}

function renderSummary(summaryRows = []){
  document.getElementById('view-summary').innerHTML = `
    <div class="card"><h2>Сводка</h2><div class="muted">Итоги по токенам или кошелькам</div></div>
    <div class="card"><div class="row">
      <input id="s-start" type="date" value="${state.filters.start}" /><input id="s-end" type="date" value="${state.filters.end}" />
      <select id="s-direction"><option value="" ${state.filters.direction === '' ? 'selected' : ''}>Все направления</option><option value="incoming" ${state.filters.direction === 'incoming' ? 'selected' : ''}>Incoming</option><option value="outgoing" ${state.filters.direction === 'outgoing' ? 'selected' : ''}>Outgoing</option></select>
      <select id="s-token"><option value="">Все токены</option>${state.whitelist.map(t => `<option value="${t.contractAddress}" ${state.filters.tokenContract === t.contractAddress ? 'selected' : ''}>${t.tokenName}</option>`).join('')}</select>
      <select id="s-tag"><option value="">Все теги</option>${state.tags.map(t => `<option value="${t.tag}" ${state.filters.walletTag === t.tag ? 'selected' : ''}>${t.tag}</option>`).join('')}</select>
      <label class="note" style="display:flex;align-items:center;gap:6px"><input id="s-include-spam" type="checkbox" ${state.filters.includeSpam ? 'checked' : ''} />Показывать нулевые/спам</label>
      <input id="s-wallet" list="wallet-options-summary" placeholder="Поиск кошелька (вставь адрес)" style="min-width:280px" value="${state.filters.walletAddress}" />
      ${walletOptionsDatalist('wallet-options-summary')}
      <button id="s-apply">Применить</button>
      <button id="s-refresh">Обновить</button>
      <button id="s-mode-token" class="${state.summaryMode === 'token' ? 'primary' : ''}">По токенам</button>
      <button id="s-mode-wallet" class="${state.summaryMode === 'wallet' ? 'primary' : ''}">По кошелькам</button>
    </div></div>
    <div class="card"><table><thead><tr><th>${state.summaryMode === 'token' ? 'Токен' : 'Кошелёк'}</th>${state.summaryMode === 'wallet' ? '<th>Теги</th>' : ''}<th>Вход</th><th>Выход</th></tr></thead>
      <tbody>${summaryRows.map(r => `<tr><td>${r.key}</td>${state.summaryMode === 'wallet' ? `<td>${(r.walletTags || []).join(', ')}</td>` : ''}<td class="in">${fmt(r.incoming)}</td><td class="out">${fmt(r.outgoing)}</td></tr>`).join('')}</tbody></table></div>`;

  const sStart = document.getElementById('s-start');
  const sEnd = document.getElementById('s-end');
  const sDirection = document.getElementById('s-direction');
  const sToken = document.getElementById('s-token');
  const sTag = document.getElementById('s-tag');
  const sIncludeSpam = document.getElementById('s-include-spam');
  const sWallet = document.getElementById('s-wallet');

  const syncSummaryFiltersFromUi = () => {
    state.filters.start = sStart.value || '';
    state.filters.end = sEnd.value || '';
    state.filters.direction = sDirection.value || '';
    state.filters.tokenContract = sToken.value || '';
    state.filters.walletTag = sTag.value || '';
    state.filters.includeSpam = !!sIncludeSpam.checked;
    state.filters.walletAddress = sWallet.value || '';
  };

  [sStart, sEnd, sDirection, sToken, sTag, sIncludeSpam, sWallet].forEach((el) => {
    el.addEventListener('change', syncSummaryFiltersFromUi);
    el.addEventListener('input', syncSummaryFiltersFromUi);
  });

  document.getElementById('s-apply').onclick = async () => {
    syncSummaryFiltersFromUi();
    await loadSummary();
  };
  document.getElementById('s-refresh').onclick = async () => { await refreshAll(); await loadSummary(); };
  document.getElementById('s-mode-token').onclick = async () => { state.summaryMode = 'token'; await loadSummary(); };
  document.getElementById('s-mode-wallet').onclick = async () => { state.summaryMode = 'wallet'; await loadSummary(); };
}

async function loadBalances() {
  const q = new URLSearchParams();
  if (state.balanceFilters.tokenContract) q.set('tokenContract', state.balanceFilters.tokenContract);
  if (state.balanceFilters.walletTag) q.set('walletTag', state.balanceFilters.walletTag);
  state.balances = await api('/api/balances' + (q.toString() ? `?${q.toString()}` : ''));
  state.balances.sort((a, b) => state.balanceSort === 'asc' ? (a.balance - b.balance) : (b.balance - a.balance));
  renderBalances();
}

function renderBalances() {
  document.getElementById('view-balances').innerHTML = `
    <div class="card"><h2>Балансы</h2><div class="muted">Баланс по выбранным токенам на кошельках из системы, сортировка от меньшего к большему.</div></div>
    <div class="card"><div class="row">
      <select id="b-token"><option value="">Все токены</option>${state.whitelist.map(t => `<option value="${t.contractAddress}" ${state.balanceFilters.tokenContract === t.contractAddress ? 'selected' : ''}>${t.tokenName}</option>`).join('')}</select>
      <select id="b-tag"><option value="">Все теги</option>${state.tags.map(t => `<option value="${t.tag}" ${state.balanceFilters.walletTag === t.tag ? 'selected' : ''}>${t.tag}</option>`).join('')}</select>
      <button id="b-sort-toggle">Сортировка: ${state.balanceSort === 'asc' ? 'по возрастанию' : 'по убыванию'}</button>
      <button id="b-apply">Применить</button>
      <button id="b-refresh">Обновить</button>
    </div></div>
    <div class="card"><table>
      <thead><tr><th>Номер кошелька</th><th>Кошелёк</th><th>Токен</th><th>Баланс</th></tr></thead>
      <tbody>${state.balances.map(r => `<tr><td>${r.walletNumber || ''}</td><td>${r.walletAddress}</td><td>${r.tokenName || r.tokenSymbol || ''}</td><td>${fmt(r.balance)}</td></tr>`).join('')}</tbody>
    </table></div>`;

  document.getElementById('b-sort-toggle').onclick = async () => {
    state.balanceSort = state.balanceSort === 'asc' ? 'desc' : 'asc';
    await loadBalances();
  };
  document.getElementById('b-apply').onclick = async () => {
    state.balanceFilters.tokenContract = document.getElementById('b-token').value || '';
    state.balanceFilters.walletTag = document.getElementById('b-tag').value || '';
    await loadBalances();
  };
  document.getElementById('b-refresh').onclick = loadBalances;
}

function renderTagsAdmin(){
  const untagged = state.wallets.filter(w => !(w.tags || []).length);
  document.getElementById('view-tags').innerHTML = `
    <div class="card"><h2>Администрирование тегов</h2><div class="muted">Назначай один тег сразу нескольким кошелькам</div></div>
    <div class="card"><div class="row">
      <input id="tag-name" placeholder="Название тега (например company-a)" style="min-width:260px" />
      <button id="tag-assign" class="primary">Назначить выбранным кошелькам</button>
      <span id="tag-note" class="note"></span>
    </div></div>
    <div class="card"><h3>Кошельки без тегов</h3>
      <div class="muted">${untagged.length ? '' : 'Нет кошельков без тегов'}</div>
      <ul>${untagged.map(w => `<li>${w.address}</li>`).join('')}</ul>
    </div>
    <div class="card"><h3>Список тегов</h3>
      <table><thead><tr><th>Тег</th><th>Кол-во кошельков</th></tr></thead>
      <tbody>${state.tags.map(t => `<tr><td>${t.tag}</td><td>${t.walletCount}</td></tr>`).join('')}</tbody></table>
    </div>
    <div class="card"><h3>Выбери кошельки для назначения тега</h3>
      <table><thead><tr><th></th><th>Address</th><th>Label</th><th>Текущие теги</th></tr></thead>
      <tbody>${state.wallets.map(w => `<tr><td><input type="checkbox" data-wallet-check="${w.id}" /></td><td>${w.address}</td><td>${w.label || ''}</td><td>${(w.tags || []).map(t => t.tag).join(', ')}</td></tr>`).join('')}</tbody></table>
    </div>`;

  document.getElementById('tag-assign').onclick = async () => {
    const tag = document.getElementById('tag-name').value.trim();
    const walletIds = Array.from(document.querySelectorAll('[data-wallet-check]:checked')).map(el => el.dataset.walletCheck);
    const note = document.getElementById('tag-note');
    if (!tag) {
      note.textContent = 'Укажи название тега';
      return;
    }
    if (!walletIds.length) {
      note.textContent = 'Выбери хотя бы один кошелёк';
      return;
    }
    try {
      const r = await api('/api/tags/assign', { method: 'POST', body: JSON.stringify({ tag, walletIds }) });
      note.textContent = `Готово: назначено ${r.assigned}/${r.wallets}`;
      await refreshAll();
      renderTagsAdmin();
      renderTransfers();
      await loadSummary();
    } catch (e) {
      note.textContent = 'Ошибка: ' + e.message;
    }
  };
}

function renderSettings(){
  document.getElementById('view-settings').innerHTML = `
    <div class="card"><h2>Настройки</h2><div class="muted">Автообновление + роли</div></div>
    <div class="card"><div class="row"><label>Auto-refresh interval:</label><select><option>1 minute</option><option>1 hour</option><option>1 day</option></select><button class="primary">Сохранить</button></div></div>
    <div class="card"><h3>Роли доступа</h3><ul><li><b>admin</b> — полный доступ</li><li><b>read_only</b> — только просмотр</li></ul></div>`;
}

async function refreshAll() {
  state.wallets = await api('/api/wallets');
  state.whitelist = await api('/api/whitelist');
  state.tags = await api('/api/tags');
  const q = buildQueryFromFilters(state.filters);
  state.transfers = await api('/api/transfers' + (q ? '?' + q : ''));
}

(async function init() {
  renderNav();
  await refreshAll();
  renderOverview();
  renderWallets();
  renderWhitelist();
  renderTransfers();
  await loadSummary();
  renderSettings();
  await setTab('overview');
})();
</script>
</body>
</html>
